# .github/workflows/prepare-release.yaml
name: prepare-release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Base version (e.g., 1.0.0)'
        required: true
        type: string
      prerelease_type:
        description: 'Pre-release type (none for stable preparation)'
        required: false
        type: choice
        options:
          - none
          - alpha
          - beta
          - rc
        default: none

env:
  CHANGIE_VERSION: "1.20.0"
  GO_VERSION: "1.24"

jobs:
  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          
      - name: Setup changie
        uses: ./.github/actions/setup-changie
        with:
          go-version: ${{ env.GO_VERSION }}
          changie-version: ${{ env.CHANGIE_VERSION }}

      - name: Calculate version with auto-increment
        id: version
        run: |
          # Note: Similar logic exists in release.yaml but with different outputs
          # Keep these in sync if you modify the version calculation logic

          BASE_VERSION="${{ github.event.inputs.version }}"
          PRERELEASE="${{ github.event.inputs.prerelease_type }}"
          
          # Remove 'v' prefix if present
          BASE_VERSION="${BASE_VERSION#v}"
          
          if [ "$PRERELEASE" == "none" ]; then
            # Stable release preparation
            VERSION="${BASE_VERSION}"
            FULL_VERSION="v${BASE_VERSION}"
            PRERELEASE_SUFFIX=""
            echo "üìù Preparing stable release v${BASE_VERSION}"
          else
            # Pre-release - calculate next suffix number
            echo "üîç Finding existing ${PRERELEASE} tags for ${BASE_VERSION}..."
            
            # Get all tags matching this base version and prerelease type
            EXISTING_TAGS=$(git tag -l "v${BASE_VERSION}-${PRERELEASE}.*" | sort -V)
            
            if [ -z "$EXISTING_TAGS" ]; then
              # No existing tags, start with .1
              SUFFIX=1
              echo "‚ú® First ${PRERELEASE} preparation for ${BASE_VERSION}"
            else
              # Find the highest suffix number
              LAST_TAG=$(echo "$EXISTING_TAGS" | tail -1)
              LAST_SUFFIX=$(echo "$LAST_TAG" | grep -oP "${PRERELEASE}\.\K[0-9]+$")
              SUFFIX=$((LAST_SUFFIX + 1))
              echo "üìà Found existing tags, next will be .${SUFFIX}"
            fi
            
            VERSION="${BASE_VERSION}-${PRERELEASE}.${SUFFIX}"
            FULL_VERSION="v${VERSION}"
            PRERELEASE_SUFFIX="${PRERELEASE}.${SUFFIX}"
            echo "üìù Preparing pre-release ${FULL_VERSION}"
          fi
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "full_version=${FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "base_version=${BASE_VERSION}" >> $GITHUB_OUTPUT
          echo "branch=feature/prepare-release-${FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "prerelease=${PRERELEASE}" >> $GITHUB_OUTPUT
          echo "prerelease_suffix=${PRERELEASE_SUFFIX}" >> $GITHUB_OUTPUT

      - name: Check if preparation already exists
        id: check
        run: |
          VERSION=${{ steps.version.outputs.version }}
          FULL_VERSION=${{ steps.version.outputs.full_version }}
          
          # Check if this exact version is already in CHANGELOG
          if grep -q "^## ${VERSION}" CHANGELOG.md 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Version ${VERSION} already in CHANGELOG.md"
            echo ""
            echo "This version has already been prepared."
            echo "If you need to create another pre-release, the suffix has already been incremented."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚úÖ New release preparation needed for ${FULL_VERSION}"
          fi

      - name: Create preparation branch
        if: steps.check.outputs.exists == 'false'
        run: |
          BRANCH=${{ steps.version.outputs.branch }}
          
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git checkout -b "${BRANCH}"
          
          echo "‚úÖ Created branch: ${BRANCH}"

      - name: Batch changelog with changie
        if: steps.check.outputs.exists == 'false'
        run: |
          VERSION=${{ steps.version.outputs.version }}
          BASE_VERSION=${{ steps.version.outputs.base_version }}
          PRERELEASE=${{ steps.version.outputs.prerelease }}
          PRERELEASE_SUFFIX="${{ steps.version.outputs.prerelease_suffix }}"
          
          # Determine version bump type from version number
          # Note: changie latest -r returns version WITHOUT 'v' prefix (e.g., "1.0.0")
          CURRENT_VERSION=$(changie latest -r 2>/dev/null || echo "0.0.0")
          
          # Remove any pre-release suffix from current version for comparison
          CURRENT_BASE=$(echo "$CURRENT_VERSION" | sed 's/-.*$//')
          
          echo "üìä Current version: ${CURRENT_VERSION} (base: ${CURRENT_BASE})"
          echo "üìä Target version: ${BASE_VERSION}"
          
          IFS='.' read -r CURR_MAJOR CURR_MINOR CURR_PATCH <<< "$CURRENT_BASE"
          IFS='.' read -r NEW_MAJOR NEW_MINOR NEW_PATCH <<< "$BASE_VERSION"
          
          if [ "$NEW_MAJOR" != "$CURR_MAJOR" ]; then
            BUMP="major"
          elif [ "$NEW_MINOR" != "$CURR_MINOR" ]; then
            BUMP="minor"
          else
            BUMP="patch"
          fi
          
          echo "üìù Running changie batch ${BUMP} for v${VERSION}..."
          
          # Run changie batch with FULL pre-release suffix
          if [ -n "$PRERELEASE_SUFFIX" ]; then
            echo "üè∑Ô∏è Including pre-release suffix: ${PRERELEASE_SUFFIX}"
            changie batch ${BUMP} -p ${PRERELEASE_SUFFIX} --keep
          else
            changie batch ${BUMP}
          fi
          
          # Merge into CHANGELOG.md
          changie merge
          
          # Verify the version was created correctly
          if ! grep -q "^## v${VERSION} - " CHANGELOG.md; then
            echo "::error::Expected version '${VERSION}' not found in CHANGELOG.md"
            echo "Found instead:"
            head -5 CHANGELOG.md
            exit 1
          fi
          
          echo "‚úÖ Changelog version verified: ${VERSION}"
          
          # Show what was generated
          echo ""
          echo "üìÑ Generated changelog:"
          head -40 CHANGELOG.md

      - name: Count changes
        if: steps.check.outputs.exists == 'false'
        id: changes
        run: |
          CHANGE_COUNT=$(find .changes/unreleased -type f ! -name '.gitkeep' 2>/dev/null | wc -l || echo 0)
          echo "count=${CHANGE_COUNT}" >> $GITHUB_OUTPUT
          echo "üìä Batched ${CHANGE_COUNT} changes"

      - name: Commit and push
        if: steps.check.outputs.exists == 'false'
        run: |
          VERSION=${{ steps.version.outputs.version }}
          FULL_VERSION=${{ steps.version.outputs.full_version }}
          BRANCH=${{ steps.version.outputs.branch }}
          PRERELEASE=${{ steps.version.outputs.prerelease }}
          
          COMMIT_MSG="chore: prepare release ${FULL_VERSION}"
          
          git add .changes/ CHANGELOG.md
          git commit -m "${COMMIT_MSG}

          - Batch unreleased changes with changie
          - Update CHANGELOG.md for ${FULL_VERSION}
          
          This prepares the changelog for the ${FULL_VERSION} release."
          
          git push origin "${BRANCH}"
          
          echo "‚úÖ Pushed to ${BRANCH}"

      - name: Create PR
        if: steps.check.outputs.exists == 'false'
        run: |
          VERSION=${{ steps.version.outputs.version }}
          FULL_VERSION=${{ steps.version.outputs.full_version }}
          BASE_VERSION=${{ steps.version.outputs.base_version }}
          BRANCH=${{ steps.version.outputs.branch }}
          CHANGE_COUNT=${{ steps.changes.outputs.count }}
          PRERELEASE=${{ steps.version.outputs.prerelease }}
          
          # Extract changelog preview
          PREVIEW=$(awk "/^## ${VERSION}/ {flag=1; next} /^## / {flag=0} flag" CHANGELOG.md | head -30)
          
          if [ "$PRERELEASE" == "none" ]; then
            PR_TITLE="üöÄ Prepare release ${FULL_VERSION}"
            RELEASE_TYPE="stable"
            NEXT_STEPS="After merging this PR, create the release:
             \`\`\`bash
             gh workflow run release.yaml -f version=${BASE_VERSION} -f release_type=stable
             \`\`\`"
          else
            PR_TITLE="üß™ Prepare pre-release ${FULL_VERSION}"
            RELEASE_TYPE="pre-release (${PRERELEASE})"
            NEXT_STEPS="After merging this PR, create the pre-release:
             \`\`\`bash
             gh workflow run release.yaml -f version=${BASE_VERSION} -f release_type=${PRERELEASE}
             \`\`\`
             
             **Note:** The release workflow will auto-increment to ${FULL_VERSION}"
          fi
          
          PR_BODY="## üöÄ Prepare Release ${FULL_VERSION}
          
          **Type:** ${RELEASE_TYPE}  
          **Changes batched:** ${CHANGE_COUNT}
          
          ### üìù Changelog Preview
          
          <details>
          <summary>Click to expand (${CHANGE_COUNT} changes)</summary>
          
          \`\`\`markdown
          ${PREVIEW}
          \`\`\`
          
          </details>
          
          ### üîÑ Next Steps
          
          ${NEXT_STEPS}
          
          ### ‚úÖ Review Checklist
          
          - [ ] Changelog entries are accurate and complete
          - [ ] Version number is correct (${FULL_VERSION})
          - [ ] Ready to proceed with release
          
          ---
          
          _Generated by \`changie batch\` with ${CHANGE_COUNT} unreleased changes._"
          
          # Check if PR already exists for this branch
          EXISTING_PR=$(gh pr list --head "${BRANCH}" --json number --jq '.[0].number' 2>/dev/null || echo "")
          
          if [ -n "$EXISTING_PR" ]; then
            echo "‚ÑπÔ∏è  PR #${EXISTING_PR} already exists for branch ${BRANCH}"
            PR_URL=$(gh pr view "${EXISTING_PR}" --json url --jq '.url')
            echo "üìç ${PR_URL}"
            echo ""
            echo "‚ö†Ô∏è  Skipping PR creation. If you need to update the PR, please do so manually or close the existing PR first."
          else
            gh pr create \
              --base main \
              --head "${BRANCH}" \
              --title "${PR_TITLE}" \
              --body "${PR_BODY}" \
              --label "release" \
              --label "changelog"
            echo "‚úÖ Pull request created successfully"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Workflow complete
        if: steps.check.outputs.exists == 'false'
        run: |
          VERSION=${{ steps.version.outputs.version }}
          FULL_VERSION=${{ steps.version.outputs.full_version }}
          PRERELEASE=${{ steps.version.outputs.prerelease }}
          BASE_VERSION=${{ steps.version.outputs.base_version }}
          
          echo "‚úÖ Preparation complete for ${FULL_VERSION}!"
          echo ""
          echo "üìã Summary:"
          echo "  - Version: ${FULL_VERSION}"
          echo "  - Type: $([ "$PRERELEASE" == "none" ] && echo "stable" || echo "pre-release (${PRERELEASE})")"
          echo "  - Changes: ${{ steps.changes.outputs.count }}"
          echo ""
          echo "üîÑ Next steps:"
          echo "  1. Review and merge the PR"
          echo "  2. Run: gh workflow run release.yaml -f version=${BASE_VERSION} -f release_type=$([ "$PRERELEASE" == "none" ] && echo "stable" || echo "${PRERELEASE}")"

      - name: Already prepared
        if: steps.check.outputs.exists == 'true'
        run: |
          VERSION=${{ steps.version.outputs.version }}
          FULL_VERSION=${{ steps.version.outputs.full_version }}
          BASE_VERSION=${{ steps.version.outputs.base_version }}
          PRERELEASE=${{ steps.version.outputs.prerelease }}
          
          echo "‚ÑπÔ∏è Release ${FULL_VERSION} is already prepared in CHANGELOG.md"
          echo ""
          echo "You can proceed with creating the release:"
          echo "  gh workflow run release.yaml -f version=${BASE_VERSION} -f release_type=$([ "$PRERELEASE" == "none" ] && echo "stable" || echo "${PRERELEASE}")"